{% extends "allauth/base.html" %} 
{% load cfilters %}


{% block breadcumb %}

<div class="col s12" style="padding-left:50px;">
        <a href="/" class="breadcrumb">Home</a>
        <a class="breadcrumb" href="{% url 'cart:viewcart' %}">Cart</a>
        <a class="breadcrumb">Checkout</a>
</div>

{% endblock %}

{% block content %}
<style type="text/css">
	#total{	
    font-size:35px;
	}
</style>

<div class="container">
	<div class="row">
		<div class="col s12">
			<h4 class="center">Checkout</h4>
<form method="POST" action="{% url 'payment:requestpayment' %}">{% csrf_token %}
	<table class="highlight centered">
        <thead>
          <tr>
              <th data-field="name">Item Name</th>
              <th data-field="quantity">Quantity</th>
              <th data-field="size">Size</th>
              <th data-field="price">Price</th>
          </tr>
        </thead>

        <tbody>
        {% for p in products %}
        <input type="hidden" name="id" value="{{ p.id }}">
        <input type="hidden" name="productname" value="{{ p.name }}">
          <tr>
            <td>
            	<div class="chip transparent black-text">
	    <img src="{{ p.get_image_url }}" alt="">
	    <b>{{ p.name }}</b>
	  </div>
            </td>
            <td>

		<div class="input-field col s8 offset-s2">
		<select id="select{{ p.id }}" name="quantity" data-id="{{ p.id }}"" data-baseprice="{{ p.price }}" > 
		<option value="" disabled selected>Select Quantity</option>
		{% for i in p.stockcount|list %}
		{% if i == 1 %}
		<option value="{{ i }}" selected="selected">{{ i }}</option>
		{% else %}
		<option value="{{ i }}" >{{ i }}</option>
		{% endif %}
		{% endfor %}
		</select>
		</div>
            </td>
                        <td>
                        {% ifnotequal p.get_sizes_of_product.0.0 "0" %}
		<div class="input-field col s8 offset-s2">
		<select id="sizeid{{ p.id }}" name="size" onchange="checkavailability($(this).val(),{{ p.id }})" data-baseprice="{{ p.price }}" > 
		<option value="" disabled selected>Select Size</option>
		{% for i in p.get_sizes_of_product %}
		{% if i == p.get_sizes_of_product.0 %}
		<option value="{{ i.0 }}" selected="selected">{{ i.0 }}</option>
		{% else %}
		<option value="{{ i.0 }}" >{{ i.0 }}</option>
		{% endif %}
		{% endfor %}
		</select>
		</div>
		{% else %}
		<input readonly type="hidden" class="input-field col s8 offset-s2 black-text" value="N/A" name="size">
		<b>Not applicable</b>
		{% endifnotequal %}
            </td>

            <td >
            <input disabled class="input-field col s8 offset-s2 black-text" onChange="findtotal()" type="text" id="change{{ p.id }}" name="productprice"  />
            </td>
			<script type="text/javascript">
			$(function() { 
			$('#select{{ p.id }}').change(function() {
			var bp = Number($(this).attr('data-baseprice'))
			var pid = $(this).attr('data-id')
			$('#change{{ p.id }}').val(Number($(this).val()) * bp);
			checkavailability($('#sizeid'+pid).val(),pid)
			findtotal();
			}).change(); // Trigger the event
			});
			</script>
          </tr>
          {% endfor %}
          <tr>

          	<td></td>
          	<td></td>
          	<td><h5>Total</h5></td>
          	<td>
          	
          		<div class="row">
	        <div class="col s12">
	        <div class="input-field inline">
          		<i class="fa fa-inr fa-1x prefix" aria-hidden="true"></i><input readonly name="grandtotal" class="black-text" id="total">
	        </div>
        </div>
        </div>
<!--           <i class="material-icons prefix">account_circle</i>
          <input id="icon_prefix" type="text" class="validate">
 -->
          	</td>
          </tr>
        </tbody>
      </table>
      <a class="" href="{% url 'cart:viewcart' %}">Edit Cart</a>
	           

  <button id="paynow" class="btn waves-effect waves-light right" type="submit" name="action">Pay Now
    <i class="material-icons right">payment</i>
  </button>
 </form>

            <p class="red-text" id="errormessage"></p>

		</div>
	</div>
</div>

<script type="text/javascript">
	function findtotal(){
		var arr = document.getElementsByName('productprice');
		var tot=0;
		for(var i=0;i<arr.length;i++){
		if(parseInt(arr[i].value))
		tot += parseInt(arr[i].value);
		}
		$('#total').val(tot);
	}

	function checkavailability(size,id)
	{
		var data = {'size':size,'id':id,'requirednumber':$('#select'+id).val()};
		if(size){

		$.ajax({
			type : "POST",
			url : "{% url 'shopping:checkavailability' %}",
			data : data,
			beforeSend: function(){$('#paynow').addClass('disabled')},
			dataType: 'json',
			success : function(data){
				if(data['type'] == 1)
				{
					$('#paynow').removeClass('disabled');
					$('#errormessage').html("");
				}
				else
				{
					$('#errormessage').html(data['msg']);
				}
			},
			error : function(){
				$('#errormessage').html("Error occured, Check your connection!");
			}

		});//ajax ends
		}
	}

</script>
{% endblock %}